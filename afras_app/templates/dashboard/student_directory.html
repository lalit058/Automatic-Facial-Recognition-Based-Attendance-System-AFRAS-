{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Student Directory{% endblock %}

{% block extra_head %}
<style>
    /* All your existing CSS remains the same */
    .top-intro {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        gap: 20px;
        flex-wrap: wrap;
    }

    .top-intro p {
        color: var(--text-dim);
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .student-enroll {
        display: flex;
        align-items: center;
    }

    .filter-container {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        border-radius: 16px;
    }

    .search-box {
        position: relative;
        width: 300px;
    }

    .search-box input {
        width: 100%;
        background: var(--surface-light);
        border: 1px solid var(--border);
        color: white;
        padding: 12px 15px 12px 45px;
        border-radius: 12px;
        font-size: 0.9rem;
        transition: all 0.3s;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(0, 98, 255, 0.2);
    }

    .search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-dim);
        font-size: 1rem;
    }

    .filter-dropdown {
        position: relative;
        min-width: 180px;
    }

    .filter-select {
        width: 100%;
        background: var(--surface-light);
        border: 1px solid var(--border);
        color: white;
        padding: 12px 40px 12px 15px;
        border-radius: 12px;
        font-size: 0.9rem;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        transition: all 0.3s;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .filter-dropdown i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-dim);
        pointer-events: none;
    }

    .filter-tags {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
        margin-bottom: 1rem;
    }

    .filter-tag {
        background: var(--surface-light);
        border: 1px solid var(--border);
        color: var(--text-main);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-tag:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .filter-tag.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .clear-filters {
        background: transparent;
        border: 1px solid var(--warning);
        color: var(--warning);
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .clear-filters:hover {
        background: rgba(245, 158, 11, 0.1);
    }

    .results-count {
        color: var(--text-dim);
        font-size: 0.9rem;
        margin-left: auto;
        white-space: nowrap;
    }

    .results-count strong {
        color: var(--primary);
        font-weight: 800;
    }

    .directory-panel {
        background: var(--surface);
        border-radius: 24px;
        border: 1px solid var(--border);
        overflow: hidden;
        margin-top: 1rem;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
    }

    thead {
        background: rgba(255, 255, 255, 0.02);
    }

    th {
        padding: 18px 20px;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-dim);
        border-bottom: 1px solid var(--border);
    }

    td {
        padding: 13px 13px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
        vertical-align: middle;
    }

    tr:last-child td {
        border-bottom: none;
    }

    .student-profile {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .student-avatar {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        object-fit: cover;
        background: var(--surface-light);
        border: 2px solid var(--border);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .student-avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(0, 98, 255, 0.3);
        border-color: var(--primary);
    }

    .student-info span {
        display: block;
        font-size: 0.75rem;
        color: var(--text-dim);
    }

    .dept-tag {
        padding: 4px 10px;
        background: rgba(0, 98, 255, 0.1);
        color: var(--primary);
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .id-badge {
        font-family: 'JetBrains Mono', monospace;
        background: var(--surface-light);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .btn-add {
        background: var(--primary);
        color: white;
        text-decoration: none;
        padding: 12px 20px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.85rem;
        transition: 0.3s;
        white-space: nowrap;
    }

    .btn-add:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 98, 255, 0.4);
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
        opacity: 1;
    }

    .btn-view,
    .btn-edit,
    .btn-delete,
    .btn-document {
        width: 36px;
        height: 36px;
        padding: 0;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: all 0.2s;
    }

    .btn-view {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid var(--success);
    }

    .btn-view:hover {
        background: var(--success);
        color: white;
    }

    .btn-edit {
        background: rgba(59, 130, 246, 0.1);
        color: var(--primary);
        border: 1px solid var(--primary);
    }

    .btn-edit:hover {
        background: var(--primary);
        color: white;
    }

    .btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid var(--danger);
    }

    .btn-delete:hover {
        background: var(--danger);
        color: white;
    }

    .btn-document {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
        border: 1px solid var(--warning);
    }

    .btn-document:hover {
        background: var(--warning);
        color: white;
    }

    @media (max-width: 1200px) {
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }

        .btn-view,
        .btn-edit,
        .btn-delete,
        .btn-document {
            width: 32px;
            height: 32px;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: row;
            justify-content: center;
        }

        .btn-view,
        .btn-edit,
        .btn-delete,
        .btn-document {
            width: 28px;
            height: 28px;
            font-size: 0.7rem;
        }
    }

    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .confirmation-modal {
        background: var(--surface);
        width: 90%;
        max-width: 500px;
        border-radius: 24px;
        padding: 2.5rem;
        position: relative;
        border: 1px solid var(--border);
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 1.5rem;
    }

    .warning-icon {
        color: var(--warning);
        font-size: 2rem;
    }

    .modal-buttons {
        display: flex;
        gap: 15px;
        margin-top: 2rem;
        justify-content: flex-end;
    }

    .btn-cancel {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-main);
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
    }

    .btn-confirm-delete {
        background: var(--danger);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
    }

    .csrf-token {
        display: none;
    }

    /* PHOTO MODAL STYLES */
    .photo-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .photo-modal {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        animation: zoomIn 0.3s ease;
    }

    @keyframes zoomIn {
        from {
            transform: scale(0.9);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .modal-photo {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        object-fit: contain;
        background: #000;
    }

    .modal-close {
        position: absolute;
        top: -40px;
        right: -40px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }

    .modal-info {
        margin-top: 20px;
        text-align: center;
        color: white;
    }

    .modal-info h3 {
        font-size: 1.2rem;
        margin-bottom: 5px;
        color: white;
    }

    .modal-info p {
        color: var(--text-dim);
        font-size: 0.9rem;
    }

    /* Zoom controls */
    .zoom-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 30px;
        backdrop-filter: blur(10px);
    }

    .zoom-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .zoom-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .download-btn {
        background: rgba(0, 98, 255, 0.2);
        border: 1px solid rgba(0, 98, 255, 0.4);
        color: var(--primary);
    }

    .download-btn:hover {
        background: rgba(0, 98, 255, 0.3);
    }
</style>
{% endblock %}
{% block content %}
<header class="top-intro">
    <div>
        <h2>Student Directory</h2>
        <p>All enrolled students in the AFRAS ecosystem.</p>
    </div>

    <div class="student-enroll">
        <a href="{% url 'register-student' %}" class="btn-add">
            <i class="fas fa-plus"></i> Enroll Student
        </a>
    </div>
</header>

<div class="filter-container">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="studentSearch" placeholder="Search by name, roll number, department, or section...">
    </div>

    <div class="filter-dropdown">
        <i class="fas fa-graduation-cap"></i>
        <select id="semesterFilter" class="filter-select">
            <option value="all">All Semesters</option>
            <option value="1">Semester 1</option>
            <option value="2">Semester 2</option>
            <option value="3">Semester 3</option>
            <option value="4">Semester 4</option>
            <option value="5">Semester 5</option>
            <option value="6">Semester 6</option>
            <option value="7">Semester 7</option>
            <option value="8">Semester 8</option>
        </select>
    </div>

    <div class="filter-dropdown">
        <i class="fas fa-building"></i>
        <select id="sectionFilter" class="filter-select">
            <option value="all">All Sections</option>
            <!-- Sections will be populated dynamically -->
        </select>
    </div>

    <button id="clearFilters" class="clear-filters">
        <i class="fas fa-times-circle"></i> Clear Filters
    </button>

    <div class="results-count" id="resultsCount">
        Showing <strong id="visibleCount">{{ students|length }}</strong> of <strong>{{ students|length }}</strong>
        students
    </div>
</div>

<div class="filter-tags" id="filterTags"></div>

<div class="directory-panel">
    <table>
        <thead>
            <tr>
                <th>Student</th>
                <th>Roll Number</th>
                <th>Department</th>
                <th>Semester & Section</th>
                <th>Contact Info</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="studentTableBody">
            {% for student in students %}
            <tr data-student-id="{{ student.id }}" data-student-name="{{ student.full_name }}"
                data-semester="{{ student.semester }}" data-section="{{ student.section|lower }}">
                <td>
                    <div class="student-profile">
                        {% if student.photo %}
                        <img src="{{ student.photo.url }}" class="student-avatar" alt="{{ student.full_name }}"
                            onclick="openStudentPhotoModal('{{ student.photo.url }}', '{{ student.full_name }}', 'Semester {{ student.semester }} - Section {{ student.section }}')"
                            title="Click to view full size">
                        {% else %}
                        <div class="student-avatar"
                            style="display: flex; align-items: center; justify-content: center; cursor: pointer;"
                            onclick="openStudentPhotoModal('https://ui-avatars.com/api/?name={{ student.full_name }}&background=0062ff&color=fff', '{{ student.full_name }}', 'Semester {{ student.semester }} - Section {{ student.section }}')"
                            title="Click to view full size">
                            <i class="fas fa-user-graduate" style="opacity: 0.3; font-size: 1.5rem;"></i>
                        </div>
                        {% endif %}
                        <div class="student-info">
                            {{ student.full_name }}
                            <strong>
                                <span class="semester-badge" style="color: var(--success); font-size: 0.7rem;">
                                    <i class="fas fa-calendar-alt"></i> Sem {{ student.semester }}
                                </span>
                            </strong>
                            <span><strong>Enrolled:</strong> {{ student.registration_date|date:"d M Y" }}</span>
                        </div>
                    </div>
                </td>
                <td><span class="id-badge">{{ student.roll_number }}</span></td>
                <td><span class="dept-tag">{{ student.department }}</span></td>
                <td>
                    <strong>Semester {{ student.semester }}</strong>
                    <span style="display: block; font-size: 0.75rem; color: var(--text-dim); margin-top: 5px;">
                        Section: {{ student.section }}
                    </span>
                </td>
                <td>
                    <div style="font-size: 0.8rem;">
                        <i class="fas fa-phone" style="width: 15px; color: var(--primary);"></i>
                        {{ student.phone_number }}<br>
                        <i class="fas fa-envelope" style="width: 15px; color: var(--primary);"></i>
                        <a style="text-decoration: none; color: var(--text-main);" href="mailto:{{ student.email }}" class="email-link">
                            {{ student.email|default:"No email" }}
                        </a>
                    </div>
                </td>

                <td>
                    <div class="action-buttons">
                        <button class="btn-view" title="View Profile"
                            onclick="openProfileModal('{{ student.full_name }}', '{{ student.roll_number }}', '{{ student.department }}', '{{ student.semester }}', '{{ student.section|default:'A' }}', '{{ student.photo.url|default:'' }}', '{{ student.registration_date|date:'d M Y' }}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-edit" title="Edit Student"
                            onclick="window.location.href='{% url 'edit-student' student.id %}'">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% if student.id_proof %}
                        <a href="{{ student.id_proof.url }}" target="_blank" class="btn-document" title="View Document">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                        {% else %}
                        <button class="btn-document" title="No Document" disabled>
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        {% endif %}
                        {% if request.user.is_superuser %}
                        <button class="btn-delete" title="Delete Student"
                            data-delete-url="{% url 'delete-student' student.id %}"
                            onclick="showDeleteConfirmation('{{ student.id }}', '{{ student.full_name }}', this)">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 4rem; color: var(--text-dim);">
                    <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.2;"></i>
                    <p>No student records found in the database.</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="confirmation-modal" onclick="event.stopPropagation()">
        <i class="fas fa-times close-modal" onclick="closeModal()"></i>
        <div class="modal-header">
            <i class="fas fa-exclamation-triangle warning-icon"></i>
            <div>
                <h3>Confirm Deletion</h3>
                <p style="color: var(--text-dim); font-size: 0.9rem;">Are you sure you want to delete this student
                    record?</p>
            </div>
        </div>
        <div id="studentDetails"></div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-confirm-delete" onclick="deleteStudent()">
                <i class="fas fa-trash-alt"></i> Delete Student
            </button>
        </div>
    </div>
</div>

<!-- Photo Modal -->
<div id="photoModal" class="photo-modal-overlay" onclick="closePhotoModal(event)">
    <div class="photo-modal" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closePhotoModal()">
            <i class="fas fa-times"></i>
        </button>

        <img id="modalPhoto" class="modal-photo" alt="Student Photo">

        <div class="modal-info">
            <h3 id="modalName"></h3>
            <p id="modalDesignation"></p>
        </div>

        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomPhoto(0.1)" title="Zoom In">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="zoom-btn" onclick="zoomPhoto(-0.1)" title="Zoom Out">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="zoom-btn download-btn" onclick="downloadPhoto()" title="Download Photo">
                <i class="fas fa-download"></i>
            </button>
        </div>
    </div>
</div>

<input type="hidden" id="csrf_token" value="{{ csrf_token }}" class="csrf-token">
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
    const csrftoken = document.getElementById('csrf_token')?.value ||
        document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    let studentToDeleteId = null;
    let deleteUrl = '';
    const filterState = { search: '', semester: 'all', section: 'all' };

    const searchInput = document.getElementById('studentSearch');
    const semesterFilter = document.getElementById('semesterFilter');
    const sectionFilter = document.getElementById('sectionFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const filterTags = document.getElementById('filterTags');
    const visibleCount = document.getElementById('visibleCount');
    const allRows = document.querySelectorAll('#studentTableBody tr');

    // Store all student data for filtering
    const allStudentsData = Array.from(allRows).map(row => ({
        element: row,
        semester: row.getAttribute('data-semester'),
        section: row.getAttribute('data-section'),
        text: row.textContent.toLowerCase()
    }));

    // Get unique sections for a specific semester
    function getSectionsForSemester(semester) {
        if (semester === 'all') {
            const sections = new Set();
            allStudentsData.forEach(student => {
                if (student.section) sections.add(student.section.toUpperCase());
            });
            return Array.from(sections).sort();
        } else {
            const sections = new Set();
            allStudentsData.forEach(student => {
                if (student.semester === semester && student.section) {
                    sections.add(student.section.toUpperCase());
                }
            });
            return Array.from(sections).sort();
        }
    }

    // Update section dropdown based on selected semester
    function updateSectionDropdown() {
        const selectedSemester = semesterFilter.value;
        const currentSection = sectionFilter.value;
        const sections = getSectionsForSemester(selectedSemester);

        const previousValue = sectionFilter.value;

        sectionFilter.innerHTML = '<option value="all">All Sections</option>';

        sections.forEach(section => {
            const option = document.createElement('option');
            option.value = section.toLowerCase();
            option.textContent = section;
            sectionFilter.appendChild(option);
        });

        if (previousValue && sections.map(s => s.toLowerCase()).includes(previousValue)) {
            sectionFilter.value = previousValue;
            filterState.section = previousValue;
        } else {
            sectionFilter.value = 'all';
            filterState.section = 'all';
        }
    }

    // Initialize section dropdown on page load
    updateSectionDropdown();

    searchInput.addEventListener('input', function () {
        filterState.search = this.value.toLowerCase().trim();
        applyFilters();
    });

    semesterFilter.addEventListener('change', function () {
        filterState.semester = this.value;
        updateSectionDropdown();
        applyFilters();
    });

    sectionFilter.addEventListener('change', function () {
        filterState.section = this.value;
        applyFilters();
    });

    clearFiltersBtn.addEventListener('click', function () {
        searchInput.value = '';
        semesterFilter.value = 'all';
        sectionFilter.value = 'all';
        filterState.search = '';
        filterState.semester = 'all';
        filterState.section = 'all';
        updateSectionDropdown();
        applyFilters();
    });

    function applyFilters() {
        let visibleRows = 0;
        allRows.forEach(row => {
            if (row.cells.length < 5) return;

            const rowText = row.textContent.toLowerCase();
            const studentSemester = row.getAttribute('data-semester');
            const studentSection = row.getAttribute('data-section');

            let matchesSearch = !filterState.search || rowText.includes(filterState.search);
            let matchesSemester = filterState.semester === 'all' || studentSemester === filterState.semester;
            let matchesSection = filterState.section === 'all' || studentSection === filterState.section.toLowerCase();

            if (matchesSearch && matchesSemester && matchesSection) {
                row.style.display = '';
                visibleRows++;
            } else {
                row.style.display = 'none';
            }
        });
        visibleCount.textContent = visibleRows;
        updateFilterTags();
    }

    function updateFilterTags() {
        filterTags.innerHTML = '';
        if (filterState.search) filterTags.appendChild(createFilterTag('search', `Search: "${filterState.search}"`));
        if (filterState.semester !== 'all') filterTags.appendChild(createFilterTag('semester', `Semester: ${filterState.semester}`));
        if (filterState.section !== 'all') {
            const sectionName = Array.from(sectionFilter.options)
                .find(option => option.value === filterState.section)?.text || filterState.section;
            filterTags.appendChild(createFilterTag('section', `Section: ${sectionName}`));
        }
        filterTags.style.display = filterTags.children.length > 0 ? 'flex' : 'none';
    }

    function createFilterTag(type, text) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag active';
        tag.innerHTML = `${text} <i class="fas fa-times" onclick="removeFilter('${type}')"></i>`;
        return tag;
    }

    function removeFilter(type) {
        if (type === 'search') {
            searchInput.value = '';
            filterState.search = '';
        } else if (type === 'semester') {
            semesterFilter.value = 'all';
            filterState.semester = 'all';
            updateSectionDropdown();
        } else if (type === 'section') {
            sectionFilter.value = 'all';
            filterState.section = 'all';
        }
        applyFilters();
    }

    function showDeleteConfirmation(studentId, studentName, buttonElement) {
        studentToDeleteId = studentId;
        deleteUrl = buttonElement.getAttribute('data-delete-url');

        const studentRow = document.querySelector(`tr[data-student-id="${studentId}"]`);
        const studentEmail = studentRow?.querySelector('.fa-envelope')?.parentNode?.textContent.trim() || 'N/A';
        const studentDept = studentRow?.querySelector('.dept-tag')?.textContent || 'N/A';
        const studentRoll = studentRow?.querySelector('.id-badge')?.textContent || 'N/A';

        document.getElementById('studentDetails').innerHTML = `
            <div style="background: rgba(239, 68, 68, 0.05); padding: 15px; border-radius: 10px; margin: 15px 0;">
                <p><strong>Name:</strong> ${studentName}</p>
                <p><strong>Roll Number:</strong> ${studentRoll}</p>
                <p><strong>Email:</strong> ${studentEmail}</p>
                <p><strong>Department:</strong> ${studentDept}</p>
            </div>`;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    async function deleteStudent() {
        if (!studentToDeleteId || !deleteUrl) return;

        const deleteBtn = document.querySelector('.btn-confirm-delete');
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        deleteBtn.disabled = true;

        try {
            const response = await fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Remove the row from the table with animation
                const row = document.querySelector(`tr[data-student-id="${studentToDeleteId}"]`);
                if (row) {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    row.style.height = row.offsetHeight + 'px';

                    setTimeout(() => {
                        row.style.height = '0';
                        row.style.padding = '0';
                        row.style.margin = '0';
                        row.style.border = 'none';
                    }, 50);

                    setTimeout(() => {
                        row.remove();
                        // Update visible count
                        const visibleRows = document.querySelectorAll('#studentTableBody tr:not([style*="display: none"])').length;
                        visibleCount.textContent = visibleRows;
                        // Update total count
                        const totalCount = document.querySelector('#resultsCount strong:last-child');
                        if (totalCount) {
                            const currentTotal = parseInt(totalCount.textContent) || 0;
                            totalCount.textContent = currentTotal - 1;
                        }
                    }, 300);
                }

                closeModal();

                // Show success message using your base template's system
                showMessage(data.message || 'Student deleted successfully!', 'success');

            } else {
                throw new Error(data.error || 'Deletion failed');
            }
        } catch (error) {
            console.error(error);
            // Show error message
            showMessage(error.message || 'Error deleting student', 'error');
        } finally {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Student';
        }
    }

    // Function to show messages like your base template does
    function showMessage(message, type = 'success') {
        const container = document.getElementById('django-messages');

        // Make sure container exists and is visible
        if (!container) {
            console.warn('Message container not found');
            return;
        }

        container.style.display = 'flex';

        // Create message element
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${type}`;
        msgDiv.setAttribute('data-auto-dismiss', 'true');

        // Set icon based on message type
        let iconClass = 'fa-info-circle';
        if (type === 'success') iconClass = 'fa-check-circle';
        else if (type === 'error' || type === 'warning') iconClass = 'fa-exclamation-circle';

        msgDiv.innerHTML = `
        <i class="fas ${iconClass}"></i>
        <span>${message}</span>
    `;

        // Add to container
        container.appendChild(msgDiv);

        // Trigger auto-dismiss
        autoDismissMessages();
    }

    // Auto-dismiss messages (copied from your base template)
    function autoDismissMessages() {
        const messages = document.querySelectorAll('.msg[data-auto-dismiss="true"]');

        messages.forEach((msg, index) => {
            // Skip if already has timer set
            if (msg.dataset.timerSet) {
                return;
            }

            // Mark as having timer
            msg.dataset.timerSet = 'true';

            // Set timeout for dismissal 5 seconds + stagger
            setTimeout(() => {
                // Add slide up animation
                msg.style.animation = 'slideUp 0.4s ease-out forwards';

                // Remove after animation completes
                setTimeout(() => {
                    if (msg.parentNode) {
                        msg.remove();
                    }
                    const container = document.getElementById('django-messages');
                    if (container && container.children.length === 0) {
                        container.style.display = 'none';
                    }
                }, 400); // Match animation duration

            }, 5000 + (index * 300)); // 5 seconds + stagger
        });
    }

    function closeModal(event = null) {
        if (event && event.target.id !== 'deleteModal' && !event.target.classList.contains('close-modal')) return;
        document.getElementById('deleteModal').style.display = 'none';
        // Reset delete state
        studentToDeleteId = null;
        deleteUrl = '';
    }

    // PHOTO MODAL FUNCTIONS (keep as is)
    let currentZoom = 1;
    let currentPhotoUrl = '';
    let currentFileName = '';

    function openStudentPhotoModal(photoUrl, studentName, studentInfo) {
        const modal = document.getElementById('photoModal');
        const modalPhoto = document.getElementById('modalPhoto');
        const modalName = document.getElementById('modalName');
        const modalDesignation = document.getElementById('modalDesignation');

        modalPhoto.src = photoUrl;
        modalName.textContent = studentName;
        modalDesignation.textContent = studentInfo;

        currentPhotoUrl = photoUrl;
        currentFileName = `${studentName.replace(/\s+/g, '_')}_${studentInfo.replace(/\s+/g, '_')}.jpg`;

        currentZoom = 1;
        modalPhoto.style.transform = 'scale(1)';

        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closePhotoModal(event = null) {
        if (event && event.target.id !== 'photoModal' && !event.target.classList.contains('modal-close')) {
            return;
        }

        const modal = document.getElementById('photoModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function zoomPhoto(amount) {
        const modalPhoto = document.getElementById('modalPhoto');
        currentZoom += amount;

        if (currentZoom < 0.5) currentZoom = 0.5;
        if (currentZoom > 3) currentZoom = 3;

        modalPhoto.style.transform = `scale(${currentZoom})`;
        modalPhoto.style.transition = 'transform 0.3s ease';
    }

    function resetZoom() {
        const modalPhoto = document.getElementById('modalPhoto');
        currentZoom = 1;
        modalPhoto.style.transform = 'scale(1)';
        modalPhoto.style.transition = 'transform 0.3s ease';
    }

    function downloadPhoto() {
        if (!currentPhotoUrl) return;

        const link = document.createElement('a');
        link.href = currentPhotoUrl;
        link.download = currentFileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeModal();
            closePhotoModal();
        }
    });

    applyFilters();
</script>
{% endblock %}