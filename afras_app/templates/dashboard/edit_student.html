{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Update Student Record{% endblock %}

{% block extra_head %}
<link
    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">

<style>
    :root {
        --primary: #0062ff;
        --primary-glow: rgba(0, 98, 255, 0.4);
        --bg-glow: radial-gradient(circle at 50% 50%, #1e293b 0%, #030712 100%);
        --surface-card: #111827;
        --border-subtle: rgba(255, 255, 255, 0.1);
        --text-dim: #9ca3af;
        --success: #10b981;
        --warning: #f59e0b;
    }

    /* Layout Wrapper - EXACT SAME AS STAFF */
    .enrollment-page-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 100px);
        padding: 20px;
    }

    .enrollment-card {
        background: var(--surface-card);
        border: 1px solid var(--border-subtle);
        border-radius: 28px;
        padding: 2.5rem;
        width: 100%;
        max-width: 750px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
    }

    header h2 {
        font-size: 1.8rem;
        font-weight: 800;
        letter-spacing: -1px;
        margin-bottom: 8px;
        text-align: center;
        color: white;
    }

    header p {
        text-align: center;
        margin-bottom: 30px;
        color: var(--text-dim);
        font-size: 0.85rem;
    }

    /* Form Styling - EXACT SAME AS STAFF */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .input-group {
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .full-width {
        grid-column: span 2;
    }

    .input-group label {
        font-size: 0.65rem;
        font-weight: 700;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Target Django form widgets - EXACT SAME AS STAFF */
    .input-group input,
    .input-group select,
    .input-group textarea {
        background: rgba(3, 7, 18, 0.6) !important;
        border: 1px solid var(--border-subtle) !important;
        color: white !important;
        padding: 10px 14px !important;
        border-radius: 10px !important;
        font-family: 'JetBrains Mono', monospace !important;
        font-size: 0.85rem !important;
        transition: all 0.3s ease !important;
        width: 100%;
    }

    .input-group input:focus,
    .input-group select:focus {
        outline: none !important;
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 4px var(--primary-glow) !important;
    }

    input[readonly] {
        background: rgba(255, 255, 255, 0.05) !important;
        cursor: not-allowed;
        color: var(--text-dim) !important;
    }

    /* Action Buttons - EXACT SAME AS STAFF */
    .action-bar {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 2rem;
    }

    .btn-submit {
        background: var(--primary);
        color: white;
        border: none;
        padding: 14px 30px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.3s;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px var(--primary-glow);
    }

    .btn-discard {
        background: transparent;
        color: var(--text-dim);
        border: 1px solid var(--border-subtle);
        padding: 14px 30px;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: 0.3s;
    }

    .btn-discard:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }

    /* Profile Image Preview - EXACT SAME AS STAFF */
    .current-profile-preview {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }

    .preview-circle {
        width: 80px;
        height: 80px;
        border-radius: 20px;
        border: 2px solid var(--primary);
        object-fit: cover;
        padding: 3px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .preview-circle:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px var(--primary-glow);
        border-color: var(--primary);
    }

    /* Error messages styling */
    .error-message {
        color: #ef4444;
        font-size: 0.75rem;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .error-message i {
        font-size: 0.7rem;
    }

    /* Field help text */
    .field-help {
        font-size: 0.7rem;
        color: var(--text-dim);
        margin-top: 4px;
        font-style: italic;
    }

    /* PHOTO MODAL STYLES */
    .photo-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .photo-modal {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        animation: zoomIn 0.3s ease;
    }

    @keyframes zoomIn {
        from {
            transform: scale(0.9);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .modal-photo {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        object-fit: contain;
        background: #000;
    }

    .modal-close {
        position: absolute;
        top: -40px;
        right: -40px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }

    .modal-info {
        margin-top: 20px;
        text-align: center;
        color: white;
    }

    .modal-info h3 {
        font-size: 1.2rem;
        margin-bottom: 5px;
        color: white;
    }

    .modal-info p {
        color: var(--text-dim);
        font-size: 0.9rem;
    }

    /* Zoom controls */
    .zoom-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 30px;
        backdrop-filter: blur(10px);
    }

    .zoom-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .zoom-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .download-btn {
        background: rgba(0, 98, 255, 0.2);
        border: 1px solid rgba(0, 98, 255, 0.4);
        color: var(--primary);
    }

    .download-btn:hover {
        background: rgba(0, 98, 255, 0.3);
    }
</style>
{% endblock %}

{% block content %}

<div class="enrollment-page-wrapper">
    <div class="enrollment-card">
        <header>
            <div class="current-profile-preview">
                {% if student.photo %}
                <img src="{{ student.photo.url }}" class="preview-circle" id="preview-target"
                    onclick="openPhotoModal('{{ student.photo.url }}', '{{ student.full_name }}', '{{ student.roll_number }}')"
                    title="Click to view full size">
                {% else %}
                <img src="https://ui-avatars.com/api/?name={{ student.full_name }}&background=0062ff&color=fff"
                    class="preview-circle" id="preview-target"
                    onclick="openPhotoModal('https://ui-avatars.com/api/?name={{ student.full_name }}&background=0062ff&color=fff', '{{ student.full_name }}', '{{ student.roll_number }}')"
                    title="Click to view full size">
                {% endif %}
            </div>
            <h2>Update Student Record</h2>
            <p>Editing Identity: {{ student.full_name }}</p>
        </header>

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            {% if messages %}
            <div style="margin-bottom: 20px;">
                {% for message in messages %}
                <div style="padding: 12px 20px; border-radius: 10px; margin-bottom: 10px; 
                    background: {% if message.tags == 'success' %}rgba(16, 185, 129, 0.1){% else %}rgba(239, 68, 68, 0.1){% endif %};
                    border: 1px solid {% if message.tags == 'success' %}rgba(16, 185, 129, 0.3){% else %}rgba(239, 68, 68, 0.3){% endif %};
                    color: {% if message.tags == 'success' %}var(--success){% else %}#ef4444{% endif %};
                    font-size: 0.85rem; display: flex; align-items: center; gap: 10px;">
                    <i
                        class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="form-grid">
                <!-- Personal Information -->
                <div class="input-group full-width">
                    <label><i class="fas fa-user"></i> Full Name</label>
                    {{ form.full_name }}
                    {% if form.full_name.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.full_name.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="input-group">
                    <label><i class="fas fa-id-card"></i> Roll Number</label>
                    {{ form.roll_number }}
                    <div class="field-help">Roll number cannot be changed</div>
                    {% if form.roll_number.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.roll_number.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="input-group">
                    <label><i class="fas fa-phone"></i> Contact Number</label>
                    {{ form.phone_number }}
                    {% if form.phone_number.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.phone_number.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="input-group full-width">
                    <label><i class="fas fa-envelope"></i> Email Address</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.email.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <!-- Academic Information -->
                <div class="input-group">
                    <label><i class="fas fa-building"></i> Department</label>
                    {{ form.department }}
                    {% if form.department.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.department.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="input-group">
                    <label><i class="fas fa-graduation-cap"></i> Semester</label>
                    {{ form.semester }}
                    {% if form.semester.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.semester.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="input-group">
                    <label><i class="fas fa-users"></i> Section</label>
                    {{ form.section }}
                    {% if form.section.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.section.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <!-- Documents & Photos -->
                <div class="input-group full-width">
                    <label><i class="fas fa-camera"></i> Update Profile Photo</label>
                    {{ form.photo }}
                    {% if form.photo.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.photo.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="input-group full-width">
                    <label><i class="fas fa-file-pdf"></i> Update ID Proof (Optional)</label>
                    {{ form.id_proof }}
                    {% if form.id_proof.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> {{ form.id_proof.errors.0 }}
                    </div>
                    {% endif %}

                    {% if student.id_proof %}
                    <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.05); 
                        border-radius: 8px; font-size: 0.75rem;">
                        <a href="{{ student.id_proof.url }}" target="_blank"
                            style="color: var(--success); text-decoration: none; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-eye"></i> View Current ID Proof
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="action-bar">
                <a href="{% url 'student-directory' %}" class="btn-discard">Discard</a>
                <button type="submit" class="btn-submit">
                    <i class="fas fa-sync-alt"></i> Update Student
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Photo Modal -->
<div id="photoModal" class="photo-modal-overlay" onclick="closePhotoModal(event)">
    <div class="photo-modal" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closePhotoModal()">
            <i class="fas fa-times"></i>
        </button>

        <img id="modalPhoto" class="modal-photo" alt="Student Photo">

        <div class="modal-info">
            <h3 id="modalName"></h3>
            <p id="modalRoll"></p>
        </div>

        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomPhoto(0.1)" title="Zoom In">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="zoom-btn" onclick="zoomPhoto(-0.1)" title="Zoom Out">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="zoom-btn download-btn" onclick="downloadPhoto()" title="Download Photo">
                <i class="fas fa-download"></i>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Live Image Preview logic - EXACT SAME AS STAFF FORM
    const photoInput = document.querySelector('input[type="file"]');
    if (photoInput) {
        photoInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('preview-target').src = e.target.result;
                    // Update the preview image's onclick to use the new image
                    const previewImg = document.getElementById('preview-target');
                    previewImg.setAttribute('data-new-src', e.target.result);
                    previewImg.onclick = function () {
                        openPhotoModal(e.target.result, '{{ student.full_name }}', '{{ student.roll_number }}');
                    };
                }
                reader.readAsDataURL(file);
            }
        });
    }

    // Add readonly field styling
    document.addEventListener('DOMContentLoaded', function () {
        const readonlyFields = document.querySelectorAll('input[readonly]');
        readonlyFields.forEach(field => {
            field.addEventListener('click', function () {
                if (this.readOnly) {
                    alert('This field cannot be modified.');
                }
            });
        });
    });

    // PHOTO MODAL FUNCTIONS
    let currentZoom = 1;
    let currentPhotoUrl = '';
    let currentFileName = '';

    function openPhotoModal(photoUrl, studentName, studentRoll) {
        const modal = document.getElementById('photoModal');
        const modalPhoto = document.getElementById('modalPhoto');
        const modalName = document.getElementById('modalName');
        const modalRoll = document.getElementById('modalRoll');

        // Set photo and info
        modalPhoto.src = photoUrl;
        modalName.textContent = studentName;
        modalRoll.textContent = `Roll: ${studentRoll}`;

        // Store current photo URL for download
        currentPhotoUrl = photoUrl;
        currentFileName = `${studentRoll}_${studentName.replace(/\s+/g, '_')}.jpg`;

        // Reset zoom
        currentZoom = 1;
        modalPhoto.style.transform = 'scale(1)';

        // Show modal
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closePhotoModal(event = null) {
        if (event && event.target.id !== 'photoModal' && !event.target.classList.contains('modal-close')) {
            return;
        }

        const modal = document.getElementById('photoModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function zoomPhoto(amount) {
        const modalPhoto = document.getElementById('modalPhoto');
        currentZoom += amount;

        // Limit zoom range
        if (currentZoom < 0.5) currentZoom = 0.5;
        if (currentZoom > 3) currentZoom = 3;

        modalPhoto.style.transform = `scale(${currentZoom})`;
        modalPhoto.style.transition = 'transform 0.3s ease';
    }

    function resetZoom() {
        const modalPhoto = document.getElementById('modalPhoto');
        currentZoom = 1;
        modalPhoto.style.transform = 'scale(1)';
        modalPhoto.style.transition = 'transform 0.3s ease';
    }

    function downloadPhoto() {
        if (!currentPhotoUrl) return;

        const link = document.createElement('a');
        link.href = currentPhotoUrl;
        link.download = currentFileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closePhotoModal();
        }
    });

    // Optional: Add touch gesture support for mobile zoom
    let touchStartDistance = 0;

    document.getElementById('modalPhoto').addEventListener('touchstart', function (e) {
        if (e.touches.length === 2) {
            touchStartDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
        }
    });

    document.getElementById('modalPhoto').addEventListener('touchmove', function (e) {
        if (e.touches.length === 2) {
            e.preventDefault();
            const touchDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            const zoomChange = (touchDistance - touchStartDistance) * 0.01;
            zoomPhoto(zoomChange);
            touchStartDistance = touchDistance;
        }
    });
</script>
{% endblock %}